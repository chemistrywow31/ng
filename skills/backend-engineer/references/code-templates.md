# Backend Code Templates

## Table of Contents
- [Go Middleware Templates](#go-middleware-templates)
- [Swagger Setup (Go)](#swagger-setup-go--gin)
- [Go Table-Driven Test Pattern](#go-table-driven-test-pattern)
- [Node.js/Express Templates](#nodejsexpress-templates)
- [Swagger Setup (Node.js)](#swagger-setup-nodejs--express)
- [Error Response Format](#error-response-format)

---

## Go Middleware Templates

### Request ID Middleware
```go
package middleware

import (
    "github.com/gin-gonic/gin"
    "github.com/google/uuid"
)

const RequestIDKey = "X-Request-ID"

func RequestID() gin.HandlerFunc {
    return func(c *gin.Context) {
        requestID := c.GetHeader(RequestIDKey)
        if requestID == "" {
            requestID = uuid.New().String()
        }
        c.Set(RequestIDKey, requestID)
        c.Header(RequestIDKey, requestID)
        c.Next()
    }
}
```

### Structured Logger Middleware
```go
package middleware

import (
    "time"
    "github.com/gin-gonic/gin"
    "go.uber.org/zap"
)

func Logger(logger *zap.Logger) gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()
        path := c.Request.URL.Path

        c.Next()

        logger.Info("request",
            zap.String("request_id", c.GetString(RequestIDKey)),
            zap.String("method", c.Request.Method),
            zap.String("path", path),
            zap.Int("status", c.Writer.Status()),
            zap.Duration("latency", time.Since(start)),
            zap.String("client_ip", c.ClientIP()),
        )
    }
}
```

### Recovery Middleware
```go
package middleware

import (
    "net/http"
    "github.com/gin-gonic/gin"
    "go.uber.org/zap"
)

func Recovery(logger *zap.Logger) gin.HandlerFunc {
    return func(c *gin.Context) {
        defer func() {
            if err := recover(); err != nil {
                logger.Error("panic recovered",
                    zap.String("request_id", c.GetString(RequestIDKey)),
                    zap.Any("error", err),
                )
                c.AbortWithStatusJSON(http.StatusInternalServerError, gin.H{
                    "code":    "INTERNAL_ERROR",
                    "message": "Internal server error",
                })
            }
        }()
        c.Next()
    }
}
```

### Auth Middleware (JWT)
```go
package middleware

import (
    "net/http"
    "strings"
    "github.com/gin-gonic/gin"
    "github.com/golang-jwt/jwt/v5"
)

var publicPaths = map[string]bool{
    "/health":     true,
    "/login":      true,
    "/api/docs":   true,
    "/swagger":    true,  // Swagger UI and spec
}

func Auth(secret string) gin.HandlerFunc {
    return func(c *gin.Context) {
        if publicPaths[c.Request.URL.Path] {
            c.Next()
            return
        }

        authHeader := c.GetHeader("Authorization")
        if authHeader == "" {
            c.AbortWithStatusJSON(http.StatusUnauthorized, gin.H{
                "code":    "UNAUTHORIZED",
                "message": "Missing authorization header",
            })
            return
        }

        tokenString := strings.TrimPrefix(authHeader, "Bearer ")
        token, err := jwt.Parse(tokenString, func(t *jwt.Token) (interface{}, error) {
            return []byte(secret), nil
        })

        if err != nil || !token.Valid {
            c.AbortWithStatusJSON(http.StatusUnauthorized, gin.H{
                "code":    "UNAUTHORIZED",
                "message": "Invalid token",
            })
            return
        }

        if claims, ok := token.Claims.(jwt.MapClaims); ok {
            c.Set("user_id", claims["sub"])
        }
        c.Next()
    }
}
```

### Docs Endpoint Handler
```go
package handler

import (
    "net/http"
    "os"
    "github.com/gin-gonic/gin"
)

func GetDocs(c *gin.Context) {
    content, err := os.ReadFile("docs/public/user-manual.md")
    if err != nil {
        c.JSON(http.StatusNotFound, gin.H{
            "code":    "NOT_FOUND",
            "message": "Documentation not found",
        })
        return
    }
    c.JSON(http.StatusOK, gin.H{
        "content": string(content),
    })
}
```

### Swagger Setup (Go + Gin)
```go
// main.go
package main

import (
    "github.com/gin-gonic/gin"
    swaggerFiles "github.com/swaggo/files"
    ginSwagger "github.com/swaggo/gin-swagger"
    _ "yourproject/docs" // Generated by swag init
)

// @title           Your API
// @version         1.0
// @description     API Server
// @host            localhost:8080
// @BasePath        /api/v1
// @securityDefinitions.apikey BearerAuth
// @in header
// @name Authorization
func main() {
    r := gin.Default()

    // Swagger endpoint
    r.GET("/swagger/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))

    // Your routes...
    r.Run()
}
```

```go
// handler/user.go - Example with Swagger annotations
package handler

// GetUser godoc
// @Summary      Get user by ID
// @Description  Retrieve a user's profile
// @Tags         users
// @Accept       json
// @Produce      json
// @Param        id   path      int  true  "User ID"
// @Success      200  {object}  dto.UserResponse
// @Failure      401  {object}  dto.ErrorResponse
// @Failure      404  {object}  dto.ErrorResponse
// @Security     BearerAuth
// @Router       /users/{id} [get]
func GetUser(c *gin.Context) {
    // Implementation
}
```

---

## Go Table-Driven Test Pattern

```go
package service

import (
    "testing"
    "github.com/stretchr/testify/assert"
)

func TestFunctionName(t *testing.T) {
    tests := []struct {
        name    string      // Test case name
        input   InputType   // Input parameters
        want    OutputType  // Expected result
        wantErr bool        // Expect error?
        errMsg  string      // Expected error message (optional)
    }{
        {
            name:    "Happy path",
            input:   validInput,
            want:    expectedOutput,
            wantErr: false,
        },
        {
            name:    "Edge case - empty input",
            input:   emptyInput,
            want:    defaultOutput,
            wantErr: false,
        },
        {
            name:    "Error case - invalid input",
            input:   invalidInput,
            wantErr: true,
            errMsg:  "invalid input",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got, err := FunctionName(tt.input)

            if tt.wantErr {
                assert.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
                return
            }

            assert.NoError(t, err)
            assert.Equal(t, tt.want, got)
        })
    }
}
```

---

## Node.js/Express Templates

### Request ID Middleware
```typescript
// middleware/requestId.ts
import { Request, Response, NextFunction } from 'express';
import { v4 as uuidv4 } from 'uuid';

export const requestId = (req: Request, res: Response, next: NextFunction) => {
  const id = req.headers['x-request-id'] as string || uuidv4();
  req.requestId = id;
  res.setHeader('X-Request-ID', id);
  next();
};
```

### Structured Logger Middleware (Winston)
```typescript
// middleware/logger.ts
import winston from 'winston';
import { Request, Response, NextFunction } from 'express';

export const logger = winston.createLogger({
  format: winston.format.json(),
  transports: [new winston.transports.Console()],
});

export const loggerMiddleware = (req: Request, res: Response, next: NextFunction) => {
  const start = Date.now();

  res.on('finish', () => {
    logger.info('request', {
      request_id: req.requestId,
      method: req.method,
      path: req.path,
      status: res.statusCode,
      latency_ms: Date.now() - start,
    });
  });

  next();
};
```

### Error Handler
```typescript
// middleware/errorHandler.ts
import { Request, Response, NextFunction } from 'express';
import { logger } from './logger';

export class AppError extends Error {
  constructor(public code: string, message: string, public statusCode = 500) {
    super(message);
  }
}

export const errorHandler = (
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  logger.error('error', {
    request_id: req.requestId,
    error: err.message,
    stack: err.stack,
  });

  if (err instanceof AppError) {
    return res.status(err.statusCode).json({
      code: err.code,
      message: err.message,
    });
  }

  res.status(500).json({
    code: 'INTERNAL_ERROR',
    message: 'Internal server error',
  });
};
```

### Swagger Setup (Node.js + Express)
```typescript
// app.ts
import express from 'express';
import swaggerUi from 'swagger-ui-express';
import swaggerJsdoc from 'swagger-jsdoc';

const app = express();

// Swagger configuration
const swaggerOptions = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'Your API',
      version: '1.0.0',
      description: 'API documentation',
    },
    servers: [{ url: 'http://localhost:3000/api/v1' }],
    components: {
      securitySchemes: {
        BearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
        },
      },
    },
  },
  apis: ['./src/routes/*.ts', './src/controllers/*.ts'],
};

const swaggerSpec = swaggerJsdoc(swaggerOptions);

// Serve Swagger UI
app.use('/swagger', swaggerUi.serve, swaggerUi.setup(swaggerSpec));

// Your routes...
```

```typescript
// controllers/userController.ts - Example with JSDoc Swagger annotations

/**
 * @swagger
 * /users/{id}:
 *   get:
 *     summary: Get user by ID
 *     tags: [Users]
 *     security:
 *       - BearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: integer
 *         description: User ID
 *     responses:
 *       200:
 *         description: User found
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/User'
 *       401:
 *         description: Unauthorized
 *       404:
 *         description: User not found
 */
export const getUser = async (req: Request, res: Response) => {
  // Implementation
};
```

---

## Error Response Format

Standard error response structure:

```json
{
  "code": "ERROR_CODE",
  "message": "Human readable message",
  "data": null
}
```

Standard success response structure:

```json
{
  "code": "SUCCESS",
  "message": "Operation completed",
  "data": { ... }
}
```

### Common Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `VALIDATION_ERROR` | 400 | Input validation failed |
| `UNAUTHORIZED` | 401 | Missing or invalid auth |
| `FORBIDDEN` | 403 | Insufficient permissions |
| `NOT_FOUND` | 404 | Resource not found |
| `CONFLICT` | 409 | Resource conflict |
| `INTERNAL_ERROR` | 500 | Unexpected error |
